# Первоначальная настройка облака

## Создание инфраструктуры

Для работы с консольной утилитой `yc` нам нужно создать указать ID облака и директории в файле `hacks/setup-env-yandex.sh`:

- `cloud_id` - ID облака;
- `folder_id` - ID директории;

Пока что укажем те, что были созданы при регистрации аккаунта в Яндекс Облаке.

После этих действий перезапустите dev контейнер.

## Создание облако в Яндекс облаке

Создадим отдельное облако, для чего применить конфигурацию из директории `infrastructure/clouds`.

Измените параметры перед применением:

- файл `locals.tf`, перепенная `clouds` - указать список облаков, которые мы будем создавать.
- файл `providers.tf`, переменная `token` - указать токен для доступа к для Яндекс облаку. Получить токен можно командой `yc iam create-token`.
   ```hcl
   provider "yandex" {
     token = "XXX"
   }
   ```

**Note**: Не сохраняйте токен в репозитории. Это - чувствительная информация, используя ее кто-то другой сможет получить доступ к вашему облаку.

После применения кода нужно вручную в облаке привязать платежный аккаунт к созданному облаку (https://console.cloud.yandex.ru/billing/accounts/).

Укажите ID созданного облака и директории в:

- файле `hacks/setup-env-yandex.sh`, переменная `cloud_id`;
- файле `infrastructure/terraform/locals.tf`, переменная `cloud_id`.

## Создание ресурсов для Terraform/Atlantis

Нам нужно применить конфигурацию из директории `infrastructure/terraform`. В ней описаны все ресурсы, необходимые для хранение стейта терраформа и облаке service account, с помощью которого Atlantis будет получать доступ к этому стейру.

Перед применением нам нужно поменять:

- файл `locals.tf`, переменная `cloud_id`, указав id того облака в Яндексе, с которым будем работать (если не сделали это в предыдущем шаге);
- файл `providers.tf`, переменная `token` - указать токен для доступа к для Яндекс облаку. Получить токен можно командой `yc iam create-token`.

После создания инфраструктуры, замените 

1. В файле `hacks/setup-env-yandex.sh` переменные:
   - `folder_id` - ID директории с terraform `yandex_resourcemanager_folder.this`;
   - `terraform_state_keys_secret_id` - ID секрета `yandex_lockbox_secret_version.this`.
2. В файле `hacks/auto-backend-yandex.sh` переменную:
   - `bucket` - название бакета `yandex_storage_bucket.this`.

После этих действий перезапустите dev контейнер.

## Перенос tfstate в облако

Из корня репозитория выполняем команды и соглашаемся с копированием существующего стейта в бекенд:

```bash
DIR=infrastructure/clouds/ make init
```

```bash
DIR=infrastructure/terraform/ make init
```

## Заключение

Готово. Теперь вам доступна локальная разработка. Наберите из корня репозитория команду:

```bash
make
```
